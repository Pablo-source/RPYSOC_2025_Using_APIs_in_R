---
title: "Using APIs in R to obtain Indicators for interactive visualizations"
author: "`Pablo Leon-Rodenas|Data and Analytics|NHSE|RPySOC25`" 
date: 11/13/2025
date-format: long
editor: visual
format:
  revealjs:
    smaller: true 
    theme: dark
    slide-number: true
    chalkboard: 
      buttons: false
    preview-links: auto
    logo: figures/quarto.png
    css: styles.css
    footer: <https://github.com/Pablo-source>
resources:
  - demo.pdf
---

## Introduction {.smaller background="#43464B"}

- This presentations describes how to use **APIs** in R to obtain socio-economic indicators.

I will cover the following topics:

- What are APIs Application Programming Interface

- Key concepts using APIs: HTTP Requests, Authentication, Data Formats, Rate Limits, Error Handling

- Libraries required in R to interact and query APIs

- Using HHTR2 package in R

- Practical example obtaining weather data using an API


## What are APIs {.smaller background="#43464B"}

`APIs` stands for `Application Programming Interface`. They are set of `protocols` that enable `communication` between different software systems. And this can be the building blocks for software applications.

This communication enables us to `collect data` from `various sources`, such as social network sites, news websites, online marketplaces or international organisations such as the OECD. Providing us `access` to multiple `health and social indicators` that we can download and query in an `automated way`.

**APIs save time** avoiding the physical download of Excel or CSV files **facilitating** up the **data wrangling** process and also providing **real time data** that can be **made accessible** to online **apps** or **dashboards**. It can also be consumed by **predictive models** to provide latest data to time series or clustering models.

## Key concepts using APIs in R {.smaller background="#43464B"}

**`HTTP Requests`**: R communicates with APIs mainly through `HTTP methods` like GET, POST, PUT and DELETE using packages like httr or curl.

**`Authentication`**: Many APIs require API keys, tokens or OAuth for access , these are included in the request headers or parameters.

**`Data Formats`**: APIs usually return data in formats like JSON or XML, which can be easily parsed in R using packages like jsonlite or XML.

**`Rate Limits`**: APIs often limit how many requests you can make in a given time. Itâ€™s important to stay within these limits to avoid getting blocked.

**`Error Handling`**: Always handle potential issues like server errors, bad input or network failures. R packages provide tools to check and manage these gracefully.

## R packages to setup APIS {.smaller background="#43464B"}

-   We will start by using `{httr}` and `{jsonlite}` R libraries. These libraries handle the complexities of API request as functions, that can be easily used.

```{r load and install httr jsonlite libraries, echo=TRUE}
# install.packages(c("httr","jsonlite"),dependencies = TRUE)
library(httr)
library(jsonlite)
```

::::: columns
::: {.column width="40%"}
-   After loading required libraries, we make a **request** to the API in R.

-   The request is sent to the computer that has the API. And I sends back a response

-   The most simple request is to ask for data using a **GET** request. It requires a URL
:::

::: {.column width="60%"}
![](figures/03%20API%20request%20response.png)
:::
:::::

-   Example: Utility Rate Database API. Information and residential electricity rate by location.(Electricity consumption
-   We can use the API for example to obtain a

```{r GET request, echo=TRUE}
# Data.gov Utility Rates API
sample2 <- GET("http://api.data.gov/nrel/utility_rates/v3.json?api_key=sample_key&address=1600+Amphitheatre+Parkway,+Mountain+View,+CA")
# Examine the GET() output:
content(sample2)
```

Source: <https://www.dataquest.io/blog/r-api-tutorial/>

## Different Types of APIs requests {.smaller background="#43464B"}

-   Different Types of requests

-   `GET`: Asking for data to an API. Using GET() function from {httr} library: <https://httr.r-lib.org/reference/GET.html>

-   `POST`: It is used to send data to a server to create/update a resource:<https://httr.r-lib.org/reference/POST.html>

-   `PUT`: is used to send data to a server to create/update a resource: <https://httr.r-lib.org/reference/PUT.html?q=PUT#null>

-   Calling same PUT request multiple times will always produce the same result, whilst calling a POST request repeatedly have side effects of creating the same resource multiple times

## Configure an API query {.smaller background="#43464B"}

Another API example, only required parameter is an address. You provide a key (API Key) if you would like to track the API requests being made.

```{r Get Lat Long coord API,echo=TRUE}
add1 <- "1600 Amphitheatre Parkway, Mountain View, CA"
sample1 <- GET("https://maps.googleapis.com/maps/api/geocode/json", query = list(address = add1))
result1 <- content(sample1)
result1
```

## Using HHTR2 package in R 2 {.smaller background="#43464B"}

-   In R there is the `httr2` package, a comprehensive `HHTP client` that provides a modern, `pipeable API` for working with `web APIs`.
-   Builds on top of `{curl}` to provide features like explicit request objects, built-in rate limiting & retry tooling.Comprehensive `OAuth support`
-   And `secure` handling of `secrets` and `credentials`:

::::: columns
::: {.column width="40%"}
![](figures/04%20httr2_package_tidyverse.png)
:::

::: {.column width="60%"}
```{r Using HTTR2 package with security features ,echo=TRUE}
library(httr2)
req <- request("http://example.com") |>
  req_auth_basic("username", "password")
req
```
:::
:::::

-   **httr2** package: <https://tidyverse.org/blog/2025/07/httr2-1-2-0/>

## Making requests through an API {.smaller background="#43464B"}

-   Get data from `US National Weather Service` using an `API`: <https://www.weather.gov/documentation/services-web-api>
-   To obtain the grid forecast for a `point location`, use the /points endpoint to `retrieve` the current `grid forecast` endpoint by `coordinates`:
-   Using website API query `example`: https://api.weather.gov/points/39.7456,-97.0892

```{r initial weather data API,echo=TRUE}
library(httr2)

NWS_base_url <- 'https://api.weather.gov' # Base URL 

National_weather <- request(NWS_base_url) %>%  # Append now further parts of the URL. Makes a GET() request to the API
  req_url_path_append(
    'points',
    '38.8894,-77.0352'
  )  %>%  # Append further parts to the initial URL
  req_perform() # Perform a Request to get a response 
National_weather
```

-   The API will usually return a `JSON` format (JavaScript Object Notation). It is Structured data we can explore.

## Obtain the API response as a list {.smaller background="#43464B"}

-   We can `display` the contents of the JASON file in a more `readable` way:
-   Then you have to identify from the API output query, which bits to use for your analysis.
-   For that we will use the `glimpse()` function from {dplyr} package

::::: columns
::: {.column width="40%"}
```{r format JASON API query response, echo = TRUE}
library(httr2)

NWS_base_url <- 'https://api.weather.gov' # Base URL 

NWS_response <- request(NWS_base_url) %>%  # Append now further parts of the URL. Makes a GET() request to the API
  req_url_path_append(
    'points',
    '38.8894,-77.0352'
  )  %>%  # Append further parts to the initial URL
  req_perform() # Perform a Request to get a response 
NWS_response

NWS_response %>% resp_body_json() # Display JSON file contents
```
:::

::: {.column width="60%"}
```{r display API query using glimpse, echo = TRUE}
library(httr2)
library(dplyr)
NWS_base_url <- 'https://api.weather.gov' # Base URL 

NWS_response <- request(NWS_base_url) %>%  # Append now further parts of the URL. Makes a GET() request to the API
  req_url_path_append('points','38.8894,-77.0352')  %>%  # Append further parts to the initial URL
  req_perform() # Perform a Request to get a response 
NWS_response_JSON <- NWS_response %>% resp_body_json() %>% 
  glimpse() # Display JSON file contents using glipmse()
NWS_response_JSON
```
:::
:::::


## Forecast data from API response {.smaller background="#43464B"}

- Exploring the `API request() output` with the `glipse()` function, we can focus on the Hourly `forecast data`.
- Section: $ properties:List of 17 : `forecastHourly`     : chr "https://api.weather.gov/gridpoints/LWX/97,71/forecast/hourly"', $ 'forecastGridData   : chr "https://api.weather.gov/gridpoints/LWX/97,71"')

::::: columns
::: {.column width="40%"}

```{r Locate forecast info in API response, echo = TRUE}
NWS_base_url <- 'https://api.weather.gov' # Base URL 

NWS_response <- request(NWS_base_url) %>%  # Append now further parts of the URL. Makes a GET() request to the API
  req_url_path_append('points','38.8894,-77.0352')  %>%  # Append further parts to the initial URL
  req_perform() # Perform a Request to get a response 

NWS_response %>%  resp_body_json() %>% 
  glimpse() # Display JSON file contents using glipmse()
## Forecast
#Forecast_url <- NWS_response %>% resp_body_json() %>% 
#  pluck('properties','forecastHourly')
```
:::

::: {.column width="60%"}
```{r Obtaining Hourly forecast from API, echo = TRUE}
library(httr2)
library(dplyr)
library(purrr)
# 1. Isolate Forecast information from API response
Forecast_url <- NWS_response %>% 
  resp_body_json() %>% 
  pluck('properties','forecastHourly')
# 2. Display forecast data
forecast_response <- request(Forecast_url) %>% req_perform()
# 3. Finally evaluate response output
forecast_response_glipmse <- forecast_response  %>% resp_body_json() %>%  glimpse() # We display forecast for one hour at a time.
forecast_response_glipmse
```
:::
:::::

## Collect Forcast data {.smaller background="#43464B"}

- From `API request() output` information under the `properties` section, we can extract from `periods` section, single temperature values.
- We will obtain details for one of the list of 16 values displayed previously

```{r Gather temperature data as a table, echo = TRUE}
library(dplyr)
library(purrr)
# 1. Isolate periods information from API response
library(httr2)

# 1. Isolate Forecast information from API response
Forecast_url <- NWS_response %>% 
  resp_body_json() %>% 
  pluck('properties','forecastHourly')
# 2. Display forecast data
forecast_response <- request(Forecast_url) %>% req_perform()
# 3. Finally evaluate response output
#    forecast_response_glipmse <- forecast_response  %>% resp_body_json() %>%  glimpse() # We display forecast for one hour at a time.
# Forecast data
#     forecast_data <- forecast_response %>% resp_body_json() %>% pluck('properties','periods') %>%  glimpse()
# We focus now on ITERATING over temperature using MAP function
# RETURN TEMPERATURE INFO AS A TIBBLE
# Iterate over the list and get StartTime, temperature using (pluck)
detailed_forecast <- forecast_response %>% resp_body_json() %>% 
  pluck('properties','periods') %>% 
  map_dfr( 
    \(x){
      tibble(
        time = x %>% pluck('startTime'),
        temp_F = x %>%  pluck('temperature')
      )
    }
  
)
detailed_forecast
```


## Present it as a Tibble {.smaller background="#43464B"}

- From the previous slide, we can simplify the code to present the required daily temperature to be used in a plots or dashboards: 
- As explained earlier, making use of `map_df()` function we can select `time` and `temperature` to be used in **dashboards** or **Quarto reports**

```{r Tiblle daily temperature, echo=TRUE}
library(dplyr)
library(purrr)
# 1. Isolate periods information from API response
library(httr2)

detailed_forecast <- forecast_response %>% resp_body_json() %>% 
  pluck('properties','periods') %>% 
  map_dfr( 
    \(x){
      tibble(
        time = x %>% pluck('startTime'),
        temp_F = x %>%  pluck('temperature')
      )
    }
  
)
detailed_forecast
```

## Store API data as Tibble or Dataframe {.smaller background="#43464B"}

- Once we have the data extracted from the API in a Tibble format, we can easily transform it into a `Dataframe` and build `Dashboards` or `Parameterized reports`. 
- So we can tweak any API we can extract data with to select and choose those fields with relevant information. Automating the data colection process.

- **Shiny App example**
![](figures/05 Shiny app example.png)
- <https://github.com/Pablo-source/RPYSOC_2024_Docker_Shiny>

- **Shiny app Using Leaflet and geospatial data **
- <https://github.com/Pablo-source/Basic-Shiny-app>
![](figures/06 Geospatial data Shiny app.png)


- or **Parameterized reports**
<https://github.com/Pablo-source/Eurostat_labour_market/tree/main/Parameterized%20reports>


## Online resources

- National Weather Service API
<https://www.weather.gov/documentation/services-web-api>
